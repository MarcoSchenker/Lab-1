<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Cantos Encadenados y Cartas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #2a2a2a;
        }
        .section h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #45a049;
        }
        .danger {
            background-color: #f44336;
        }
        .danger:hover {
            background-color: #da190b;
        }
        .warning {
            background-color: #ff9800;
        }
        .warning:hover {
            background-color: #e68900;
        }
        .log {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .card-display {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .card {
            width: 60px;
            height: 90px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #000;
            font-size: 12px;
        }
        .suit-gold { color: #FFD700; }
        .suit-sword { color: #C0C0C0; }
        .suit-cup { color: #8B4513; }
        .suit-club { color: #228B22; }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-weight: bold;
        }
        .status.conectado { background-color: #4CAF50; }
        .status.esperando { background-color: #ff9800; }
        .status.error { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üÉè Test - Cantos Encadenados y Cartas</h1>
        
        <div class="section">
            <h3>üîó Conexi√≥n y Estado</h3>
            <div id="connectionStatus" class="status error">Desconectado</div>
            <button class="test-button" onclick="conectar()">Conectar</button>
            <button class="test-button warning" onclick="desconectar()">Desconectar</button>
        </div>

        <div class="section">
            <h3>üéÆ Crear/Unirse a Partida</h3>
            <input type="text" id="salaInput" placeholder="C√≥digo de sala (ej: 4e21c8aa)" value="test123">
            <button class="test-button" onclick="crearPartida()">Crear Partida</button>
            <button class="test-button" onclick="unirsePartida()">Unirse a Partida</button>
        </div>

        <div class="section">
            <h3>üÉè Estado de Cartas</h3>
            <div>Mis cartas:</div>
            <div id="misCartas" class="card-display"></div>
            <div>Cartas en mesa:</div>
            <div id="cartasMesa" class="card-display"></div>
            <button class="test-button" onclick="solicitarEstado()">Actualizar Estado</button>
        </div>

        <div class="section">
            <h3>üéµ Cantos de Envido</h3>
            <button class="test-button" onclick="cantarEnvido()">ENVIDO</button>
            <button class="test-button" onclick="cantarRealEnvido()">REAL ENVIDO</button>
            <button class="test-button" onclick="cantarFaltaEnvido()">FALTA ENVIDO</button>
            <br>
            <button class="test-button warning" onclick="responderQuiero()">QUIERO</button>
            <button class="test-button danger" onclick="responderNoQuiero()">NO QUIERO</button>
        </div>

        <div class="section">
            <h3>üî¢ Acciones de Juego</h3>
            <button class="test-button" onclick="jugarPrimeraCarta()">Jugar 1¬™ Carta</button>
            <button class="test-button" onclick="irseAlMazo()">Irse al Mazo</button>
            <input type="number" id="puntosEnvido" placeholder="Puntos envido" min="0" max="33">
            <button class="test-button" onclick="declararPuntos()">Declarar Puntos</button>
        </div>

        <div class="section">
            <h3>üìù Logs</h3>
            <div id="logs" class="log"></div>
            <button class="test-button warning" onclick="limpiarLogs()">Limpiar Logs</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let estadoJuego = null;
        let miUsuarioId = 2; // Marco por defecto
        let salaActual = null;

        function log(mensaje) {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `[${timestamp}] ${mensaje}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(mensaje);
        }

        function limpiarLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function actualizarEstadoConexion(estado) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${estado}`;
            statusDiv.textContent = estado === 'conectado' ? 'Conectado' : 
                                   estado === 'esperando' ? 'Esperando...' : 'Desconectado';
        }

        function mostrarCartas(cartas, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!cartas || cartas.length === 0) {
                container.innerHTML = '<div style="color: #888;">Sin cartas</div>';
                return;
            }

            cartas.forEach(carta => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                
                let suitClass = '';
                switch(carta.palo) {
                    case 'oro': suitClass = 'suit-gold'; break;
                    case 'espada': suitClass = 'suit-sword'; break;
                    case 'copa': suitClass = 'suit-cup'; break;
                    case 'basto': suitClass = 'suit-club'; break;
                }
                
                cardDiv.innerHTML = `
                    <div class="${suitClass}">${carta.numero}</div>
                    <div class="${suitClass}">${carta.palo}</div>
                `;
                container.appendChild(cardDiv);
            });
        }

        function conectar() {
            if (socket) {
                log('‚ö†Ô∏è Ya conectado');
                return;
            }

            actualizarEstadoConexion('esperando');
            log('üîó Conectando a localhost:3001...');
            
            socket = io('http://localhost:3001');

            socket.on('connect', () => {
                log('‚úÖ Conectado al servidor');
                
                // Autenticar como usuario
                socket.emit('authenticate_user', { userId: miUsuarioId, userName: 'marco' });
            });

            socket.on('authenticated', (data) => {
                log(`‚úÖ Autenticado como: ${data.userName} (ID: ${data.userId})`);
                actualizarEstadoConexion('conectado');
            });

            socket.on('estado_juego_actualizado', (estado) => {
                log('üìä Estado del juego actualizado');
                estadoJuego = estado;
                
                // Mostrar mis cartas
                const miJugador = estado.jugadores?.find(j => j.id === miUsuarioId);
                if (miJugador) {
                    log(`üÉè Tengo ${miJugador.numeroCartas || 0} cartas`);
                    mostrarCartas(miJugador.cartasMano, 'misCartas');
                }
                
                // Mostrar cartas en mesa
                const cartasMesa = estado.rondaActual?.turnoInfo?.cartasEnMesaManoActual || [];
                mostrarCartas(cartasMesa.map(c => c.carta), 'cartasMesa');
                
                // Log estado general
                log(`Estado: ${estado.estadoPartida}, Ronda: ${estado.numeroRondaActual}`);
                if (estado.rondaActual?.turnoInfo?.jugadorTurnoActualId) {
                    log(`Turno de jugador: ${estado.rondaActual.turnoInfo.jugadorTurnoActualId}`);
                }
            });

            socket.on('canto_realizado', (data) => {
                log(`üéµ Canto realizado: ${data.tipo_canto} por jugador ${data.jugadorId}`);
                if (data.esCantoEncadenado) {
                    log('üîó Es un canto encadenado!');
                }
            });

            socket.on('error_juego', (error) => {
                log(`‚ùå Error: ${error.message}`);
            });

            socket.on('disconnect', () => {
                log('‚ùå Desconectado del servidor');
                actualizarEstadoConexion('error');
                socket = null;
            });
        }

        function desconectar() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            actualizarEstadoConexion('error');
            log('üîå Desconectado');
        }

        function crearPartida() {
            const codigoSala = document.getElementById('salaInput').value;
            if (!codigoSala) {
                log('‚ùå Ingresa un c√≥digo de sala');
                return;
            }
            
            log(`üéÆ Creando partida: ${codigoSala}`);
            // Aqu√≠ normalmente har√≠as una llamada HTTP para crear la partida
            // Por ahora solo nos unimos
            unirsePartida();
        }

        function unirsePartida() {
            if (!socket) {
                log('‚ùå No conectado');
                return;
            }
            
            const codigoSala = document.getElementById('salaInput').value;
            if (!codigoSala) {
                log('‚ùå Ingresa un c√≥digo de sala');
                return;
            }
            
            salaActual = codigoSala;
            log(`üèÅ Uni√©ndose a sala: ${codigoSala}`);
            socket.emit('unirse_sala_juego', codigoSala);
        }

        function solicitarEstado() {
            if (!socket) {
                log('‚ùå No conectado');
                return;
            }
            
            log('üì° Solicitando estado del juego...');
            socket.emit('solicitar_estado_juego_ws');
        }

        function cantarEnvido() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('üéµ Cantando ENVIDO');
            socket.emit('cantar_ws', { 
                codigoSala: salaActual, 
                tipoCanto: 'ENVIDO' 
            });
        }

        function cantarRealEnvido() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('üéµ Cantando REAL ENVIDO');
            socket.emit('cantar_ws', { 
                codigoSala: salaActual, 
                tipoCanto: 'REAL_ENVIDO' 
            });
        }

        function cantarFaltaEnvido() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('üéµ Cantando FALTA ENVIDO');
            socket.emit('cantar_ws', { 
                codigoSala: salaActual, 
                tipoCanto: 'FALTA_ENVIDO' 
            });
        }

        function responderQuiero() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('‚úÖ Respondiendo QUIERO');
            socket.emit('responder_canto_ws', { 
                codigoSala: salaActual, 
                respuesta: 'QUIERO' 
            });
        }

        function responderNoQuiero() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('‚ùå Respondiendo NO QUIERO');
            socket.emit('responder_canto_ws', { 
                codigoSala: salaActual, 
                respuesta: 'NO_QUIERO' 
            });
        }

        function jugarPrimeraCarta() {
            if (!socket || !salaActual || !estadoJuego) {
                log('‚ùå No conectado, no en sala, o sin estado');
                return;
            }
            
            const miJugador = estadoJuego.jugadores?.find(j => j.id === miUsuarioId);
            if (!miJugador || !miJugador.cartasMano || miJugador.cartasMano.length === 0) {
                log('‚ùå No tengo cartas para jugar');
                return;
            }
            
            const primeraCarta = miJugador.cartasMano[0];
            log(`üÉè Jugando carta: ${primeraCarta.numero} de ${primeraCarta.palo}`);
            
            socket.emit('jugar_carta_ws', { 
                codigoSala: salaActual, 
                idUnicoCarta: primeraCarta.idUnico 
            });
        }

        function irseAlMazo() {
            if (!socket || !salaActual) {
                log('‚ùå No conectado o no en sala');
                return;
            }
            
            log('üèÉ Y√©ndose al mazo');
            socket.emit('irse_al_mazo_ws', { 
                codigoSala: salaActual 
            });
        }

        function declararPuntos() {
            const puntos = document.getElementById('puntosEnvido').value;
            if (!socket || !salaActual || !puntos) {
                log('‚ùå No conectado, no en sala, o sin puntos');
                return;
            }
            
            log(`üî¢ Declarando ${puntos} puntos de envido`);
            socket.emit('declarar_puntos_envido_ws', { 
                codigoSala: salaActual, 
                puntos: parseInt(puntos) 
            });
        }

        // Auto conectar al cargar
        window.onload = () => {
            log('üöÄ P√°gina cargada - Test de Cantos Encadenados');
        };
    </script>
</body>
</html>
