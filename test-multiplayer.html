<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multijugador - Truco</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .player { border: 1px solid #ccc; margin: 10px; padding: 20px; background: #f9f9f9; }
        button { margin: 5px; padding: 10px; }
        .log { background: #000; color: #00ff00; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.connecting { background: #fff3cd; }
        .status.connected { background: #d4edda; }
        .status.error { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>Test Multijugador - Truco</h1>
    
    <div class="player">
        <h3>Jugador 1</h3>
        <div>
            <input type="text" id="usuario1" placeholder="Nombre usuario 1" value="TestUser1">
            <input type="email" id="email1" placeholder="Email 1" value="test1@test.com">
            <input type="password" id="password1" placeholder="Password 1" value="123456">
            <button onclick="registrarUsuario(1)">Registrar</button>
            <button onclick="loginUsuario(1)">Login</button>
        </div>
        <div>
            <button onclick="crearSala(1)">Crear Sala</button>
            <input type="text" id="codigoSala1" placeholder="C√≥digo de sala">
            <button onclick="unirseASala(1)">Unirse a Sala</button>
        </div>
        <div id="status1" class="status">Desconectado</div>
    </div>

    <div class="player">
        <h3>Jugador 2</h3>
        <div>
            <input type="text" id="usuario2" placeholder="Nombre usuario 2" value="TestUser2">
            <input type="email" id="email2" placeholder="Email 2" value="test2@test.com">
            <input type="password" id="password2" placeholder="Password 2" value="123456">
            <button onclick="registrarUsuario(2)">Registrar</button>
            <button onclick="loginUsuario(2)">Login</button>
        </div>
        <div>
            <button onclick="crearSala(2)">Crear Sala</button>
            <input type="text" id="codigoSala2" placeholder="C√≥digo de sala">
            <button onclick="unirseASala(2)">Unirse a Sala</button>
        </div>
        <div id="status2" class="status">Desconectado</div>
    </div>

    <div class="log" id="log"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        const BASE_URL = 'http://localhost:3001';
        let tokens = {};
        let sockets = {};
        let salaActual = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(player, message, type = 'connecting') {
            const statusDiv = document.getElementById(`status${player}`);
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function registrarUsuario(player) {
            const usuario = document.getElementById(`usuario${player}`).value;
            const email = document.getElementById(`email${player}`).value;
            const password = document.getElementById(`password${player}`).value;

            try {
                const response = await fetch(`${BASE_URL}/usuarios`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre_usuario: usuario,
                        email: email,
                        contrase√±a: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`Jugador ${player}: Usuario registrado exitosamente`);
                    updateStatus(player, 'Usuario registrado', 'connected');
                } else {
                    log(`Jugador ${player}: Error al registrar - ${data.error}`);
                    updateStatus(player, 'Error al registrar', 'error');
                }
            } catch (error) {
                log(`Jugador ${player}: Error de conexi√≥n - ${error.message}`);
                updateStatus(player, 'Error de conexi√≥n', 'error');
            }
        }

        async function loginUsuario(player) {
            const email = document.getElementById(`email${player}`).value;
            const password = document.getElementById(`password${player}`).value;

            try {
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        contrase√±a: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    tokens[player] = data.token;
                    log(`Jugador ${player}: Login exitoso`);
                    updateStatus(player, 'Autenticado', 'connected');
                    
                    // Conectar socket despu√©s del login
                    conectarSocket(player);
                } else {
                    log(`Jugador ${player}: Error en login - ${data.message}`);
                    updateStatus(player, 'Error en login', 'error');
                }
            } catch (error) {
                log(`Jugador ${player}: Error de conexi√≥n - ${error.message}`);
                updateStatus(player, 'Error de conexi√≥n', 'error');
            }
        }

        function conectarSocket(player) {
            if (sockets[player]) {
                sockets[player].disconnect();
            }

            log(`Jugador ${player}: Conectando socket...`);
            const socket = io(BASE_URL);
            sockets[player] = socket;

            socket.on('connect', () => {
                log(`Jugador ${player}: Socket conectado`);
                updateStatus(player, 'Socket conectado', 'connected');
                
                // Autenticar socket
                socket.emit('autenticar_socket', tokens[player]);
            });

            socket.on('autenticacion_exitosa', (data) => {
                log(`Jugador ${player}: Socket autenticado como ${data.username}`);
                updateStatus(player, `Autenticado: ${data.username}`, 'connected');
            });

            socket.on('autenticacion_fallida', (error) => {
                log(`Jugador ${player}: Error autenticaci√≥n socket - ${error.message}`);
                updateStatus(player, 'Error autenticaci√≥n socket', 'error');
            });

            socket.on('estado_juego_actualizado', (estado) => {
                log(`Jugador ${player}: ‚úÖ ESTADO RECIBIDO - Sala: ${estado.codigoSala}, Estado: ${estado.estadoPartida}, Jugadores: ${estado.jugadores.length}`);
                updateStatus(player, `En partida: ${estado.codigoSala}`, 'connected');
            });

            socket.on('esperando_inicio_partida', (data) => {
                log(`Jugador ${player}: ‚è≥ Esperando inicio de partida: ${data.mensaje}`);
                updateStatus(player, 'Esperando inicio partida', 'connecting');
            });

            socket.on('partida_iniciada', (data) => {
                log(`Jugador ${player}: üéÆ Partida iniciada en sala ${data.codigo_sala}`);
                updateStatus(player, 'Partida iniciada', 'connected');
                
                // Unirse a la sala de juego
                socket.emit('unirse_sala_juego', data.codigo_sala);
            });

            socket.on('error_juego', (error) => {
                log(`Jugador ${player}: ‚ùå Error de juego: ${error.message}`);
                updateStatus(player, 'Error en juego', 'error');
            });

            socket.on('disconnect', () => {
                log(`Jugador ${player}: Socket desconectado`);
                updateStatus(player, 'Desconectado', 'error');
            });
        }

        async function crearSala(player) {
            if (!tokens[player]) {
                log(`Jugador ${player}: Debe autenticarse primero`);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/salas/crear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokens[player]}`
                    },
                    body: JSON.stringify({
                        tipo: 'publica',
                        puntos_victoria: 15,
                        max_jugadores: 2,
                        tiempo_limite: 30
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    salaActual = data.codigo_sala;
                    document.getElementById(`codigoSala${player}`).value = salaActual;
                    log(`Jugador ${player}: Sala creada - ${salaActual}`);
                    updateStatus(player, `Sala creada: ${salaActual}`, 'connected');
                } else {
                    log(`Jugador ${player}: Error al crear sala - ${data.error}`);
                    updateStatus(player, 'Error crear sala', 'error');
                }
            } catch (error) {
                log(`Jugador ${player}: Error de conexi√≥n - ${error.message}`);
            }
        }

        async function unirseASala(player) {
            if (!tokens[player]) {
                log(`Jugador ${player}: Debe autenticarse primero`);
                return;
            }

            const codigoSala = document.getElementById(`codigoSala${player}`).value;
            if (!codigoSala) {
                log(`Jugador ${player}: Debe especificar c√≥digo de sala`);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/salas/unirse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokens[player]}`
                    },
                    body: JSON.stringify({
                        codigo_sala: codigoSala
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`Jugador ${player}: Se uni√≥ a sala ${codigoSala}`);
                    updateStatus(player, `En sala: ${codigoSala}`, 'connected');
                    
                    // Si la partida ya comenz√≥, unirse al socket de juego
                    if (data.mensaje.includes('comenzado')) {
                        if (sockets[player]) {
                            sockets[player].emit('unirse_sala_juego', codigoSala);
                        }
                    }
                } else {
                    log(`Jugador ${player}: Error al unirse - ${data.error}`);
                    updateStatus(player, 'Error unirse sala', 'error');
                }
            } catch (error) {
                log(`Jugador ${player}: Error de conexi√≥n - ${error.message}`);
            }
        }

        // Inicializar log
        log('Sistema de test inicializado');
        log('1. Registrar/Login ambos usuarios');
        log('2. Jugador 1: Crear sala');
        log('3. Jugador 2: Unirse con el c√≥digo de sala');
        log('4. Observar los logs de la partida');
    </script>
</body>
</html>
