<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truco Game Socket Test</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            gap: 20px;
        }
        .player {
            width: 45%;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .player h2 {
            color: #16a085;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .card {
            display: inline-block;
            width: 80px;
            height: 120px;
            border: 1px solid black;
            border-radius: 8px;
            margin: 5px;
            text-align: center;
            line-height: 120px;
            font-size: 18px;
            font-weight: bold;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card.oro { color: #e67e22; }
        .card.copa { color: #c0392b; }
        .card.espada { color: #2980b9; }
        .card.basto { color: #27ae60; }
        button {
            margin: 10px 0;
            padding: 8px 16px;
            background-color: #3498db;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #gameState {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #fff;
            white-space: pre-wrap;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            margin-top: 15px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .status div {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        input[type="text"] {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Truco Game Socket Test</h1>
    
    <div class="container">
        <div class="player" id="player1">
            <h2>Player 1 (Pepito90319)</h2>
            <div>
                <label for="token1">Token:</label>
                <input type="text" id="token1" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NSwibm9tYnJlX3VzdWFyaW8iOiJQZXBpdG85MDMxOSIsImVzX2Fub25pbW8iOnRydWUsImlhdCI6MTc0ODk2MzQxNSwiZXhwIjoxNzQ5MDQ5ODE1fQ.XGh_zNXZSEuK1QMEym-brYtzlEB4eLDWAgyupaWTf-U" style="width: 80%;">
            </div>
            <div>
                <label for="roomCode1">Room Code:</label>
                <input type="text" id="roomCode1" value="8c53c1dc">
            </div>
            <button onclick="connectPlayer('player1')">Connect</button>
            <button onclick="requestGameState('player1')">Get Game State</button>
            <div id="player1Cards" class="cards"></div>
            <div id="player1Status" class="status"></div>
        </div>
        
        <div class="player" id="player2">
            <h2>Player 2 (DonPedro73206)</h2>
            <div>
                <label for="token2">Token:</label>
                <input type="text" id="token2" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Niwibm9tYnJlX3VzdWFyaW8iOiJEb25QZWRybzczMjA2IiwiZXNfYW5vbmltbyI6dHJ1ZSwiaWF0IjoxNzQ4OTYzNDMxLCJleHAiOjE3NDkwNDk4MzF9.Lv1WKU2Bsjm3FyoODxewfq3KBrGfZwPyJOB37o4QEXk" style="width: 80%;">
            </div>
            <div>
                <label for="roomCode2">Room Code:</label>
                <input type="text" id="roomCode2" value="8c53c1dc">
            </div>
            <button onclick="connectPlayer('player2')">Connect</button>
            <button onclick="requestGameState('player2')">Get Game State</button>
            <div id="player2Cards" class="cards"></div>
            <div id="player2Status" class="status"></div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="refreshBothPlayers()" style="display: block; margin: 20px auto; padding: 10px 20px; background-color: #2ecc71;">
            Refresh Both Players
        </button>
    </div>

    <div id="gameState">
        <h3>Game State:</h3>
        <div id="gameStatusSummary" style="margin-bottom: 15px; padding: 10px; background-color: #f1f8e9; border-radius: 4px;"></div>
        <details>
            <summary>Full Game State JSON (Click to expand)</summary>
            <pre id="gameStateJson"></pre>
        </details>
    </div>
    
    <script>
        function refreshBothPlayers() {
            if (players.player1.socket && players.player1.socket.connected) {
                players.player1.socket.emit('cliente_solicitar_estado_juego');
            }
            if (players.player2.socket && players.player2.socket.connected) {
                players.player2.socket.emit('cliente_solicitar_estado_juego');
            }
        }
    </script>

    <script>
        const players = {
            player1: {
                socket: null,
                token: null,
                roomCode: null,
                cards: []
            },
            player2: {
                socket: null,
                token: null,
                roomCode: null,
                cards: []
            }
        };

        function connectPlayer(playerId) {
            const tokenInput = document.getElementById(`token${playerId.slice(-1)}`);
            const roomCodeInput = document.getElementById(`roomCode${playerId.slice(-1)}`);
            
            const token = tokenInput.value;
            const roomCode = roomCodeInput.value;
            
            if (!token || !roomCode) {
                updateStatus(playerId, 'Error: Token and room code are required');
                return;
            }
            
            // Store values
            players[playerId].token = token;
            players[playerId].roomCode = roomCode;
            
            // Connect to socket server
            updateStatus(playerId, 'Connecting to server...');
            
            // Create new socket connection
            const socket = io('https://6826-200-10-109-202.ngrok-free.app');
            players[playerId].socket = socket;
            
            // Setup socket event handlers
            socket.on('connect', () => {
                updateStatus(playerId, `Connected with ID: ${socket.id}`);
                
                // Authenticate
                socket.emit('autenticar_socket', token);
            });
            
            socket.on('connect_error', (error) => {
                updateStatus(playerId, `Connection error: ${error.message}`);
            });
            
            socket.on('autenticacion_exitosa', (data) => {
                updateStatus(playerId, `Authentication successful. User ID: ${data.userId}`);
                
                // Join game room
                socket.emit('unirse_sala_juego', roomCode);
            });
            
            socket.on('autenticacion_fallida', (data) => {
                updateStatus(playerId, `Authentication failed: ${data.message}`);
            });
            
            socket.on('unido_sala_juego', (data) => {
                updateStatus(playerId, `Joined game room: ${roomCode}`);
                
                // Request initial game state
                socket.emit('cliente_solicitar_estado_juego');
            });
            
            socket.on('estado_juego_actualizado', (gameState) => {
                updateStatus(playerId, 'Game state received');
                
                // Update game state display
                document.getElementById('gameStateJson').textContent = JSON.stringify(gameState, null, 2);
                
                // Update player cards
                updatePlayerCards(playerId, gameState);
                
                // Show turn info
                if (gameState.estadoRondaActual && gameState.estadoRondaActual.jugadorTurnoActualId) {
                    const isPlayerTurn = gameState.estadoRondaActual.jugadorTurnoActualId === (playerId === 'player1' ? 5 : 6);
                    const playerName = gameState.jugadores.find(j => j.id === gameState.estadoRondaActual.jugadorTurnoActualId)?.nombreUsuario;
                    
                    if (isPlayerTurn) {
                        updateStatus(playerId, `🎮 Es tu turno`);
                    } else {
                        updateStatus(playerId, `⏳ Esperando a ${playerName}`);
                    }
                }
                
                // Update game status summary
                const summaryEl = document.getElementById('gameStatusSummary');
                const currentTurnPlayer = gameState.jugadores.find(j => j.id === gameState.estadoRondaActual?.jugadorTurnoActualId);
                
                // Build team scores info
                let teamScores = gameState.equipos.map(team => 
                    `Equipo ${team.id.split('_')[1]} (${team.jugadoresIds.map(id => 
                        gameState.jugadores.find(j => j.id === id)?.nombreUsuario || `Jugador ${id}`
                    ).join(', ')}): ${team.puntosPartida} puntos`
                ).join('<br>');
                
                // Build envido/truco state info
                let cantoInfo = '';
                if (gameState.estadoRondaActual.envidoState.cantado) {
                    const estado = gameState.estadoRondaActual.envidoState.querido ? 'querido' : 
                                   gameState.estadoRondaActual.envidoState.querido === false ? 'no querido' : 'pendiente';
                    cantoInfo += `<br>Envido: ${estado} - ${gameState.estadoRondaActual.envidoState.puntosEnJuegoCalculados} puntos en juego`;
                }
                
                if (gameState.estadoRondaActual.trucoState.cantado) {
                    const estado = gameState.estadoRondaActual.trucoState.querido ? 'querido' : 
                                   gameState.estadoRondaActual.trucoState.querido === false ? 'no querido' : 'pendiente';
                    cantoInfo += `<br>Truco: ${estado} - ${gameState.estadoRondaActual.trucoState.puntosEnJuego} puntos en juego`;
                }
                
                summaryEl.innerHTML = `
                    <strong>Partida:</strong> ${gameState.codigoSala} (${gameState.tipoPartida})<br>
                    <strong>Estado:</strong> ${gameState.estadoPartida}<br>
                    <strong>Ronda actual:</strong> ${gameState.numeroRondaActual}, Mano #${gameState.estadoRondaActual.manoActualNumero}<br>
                    <strong>Jugador mano:</strong> ${gameState.jugadores.find(j => j.id === gameState.estadoRondaActual.jugadorManoRondaId)?.nombreUsuario || 'Desconocido'}<br>
                    <strong>Turno de:</strong> ${currentTurnPlayer?.nombreUsuario || 'Esperando'}<br>
                    <strong>Puntuación:</strong><br>${teamScores}
                    ${cantoInfo}
                `;
            });
            
            socket.on('error_juego', (data) => {
                updateStatus(playerId, `❌ Game error: ${data.message}`);
            });
            
            socket.on('carta_jugada', (data) => {
                const { jugadorId, carta } = data;
                const playerName = data.jugadorNombre || `Jugador ${jugadorId}`;
                updateStatus(playerId, `🃏 ${playerName} jugó ${carta.numero} de ${carta.palo}`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('canto_realizado', (data) => {
                const { jugadorId, tipoCanto } = data;
                const playerName = data.jugadorNombre || `Jugador ${jugadorId}`;
                updateStatus(playerId, `🗣️ ${playerName} cantó ${tipoCanto}`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('respuesta_canto', (data) => {
                const { jugadorId, respuesta, tipoCanto } = data;
                const playerName = data.jugadorNombre || `Jugador ${jugadorId}`;
                updateStatus(playerId, `🗣️ ${playerName} respondió ${respuesta} al ${tipoCanto}`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('envido_tantos', (data) => {
                const { jugadorId, puntos } = data;
                const playerName = data.jugadorNombre || `Jugador ${jugadorId}`;
                updateStatus(playerId, `🎯 ${playerName} tiene ${puntos} de envido`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('ronda_finalizada', (data) => {
                updateStatus(playerId, `🏁 Ronda finalizada. Ganador: Equipo ${data.equipoGanadorId}`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('partida_finalizada', (data) => {
                updateStatus(playerId, `🏆 ¡Partida finalizada! Ganador: Equipo ${data.equipoGanadorId}`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('jugador_desconectado_broadcast', (data) => {
                updateStatus(playerId, `👋 ${data.nombre_usuario || 'Jugador'} se ha desconectado`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('jugador_reconectado', (data) => {
                updateStatus(playerId, `👋 ${data.jugadorNombre || 'Jugador'} se ha reconectado`);
                
                // Request updated state
                setTimeout(() => socket.emit('cliente_solicitar_estado_juego'), 100);
            });
            
            socket.on('disconnect', () => {
                updateStatus(playerId, '⚠️ Desconectado del servidor');
            });
        }
        
        function requestGameState(playerId) {
            const socket = players[playerId].socket;
            
            if (!socket || !socket.connected) {
                updateStatus(playerId, 'Error: Not connected to server');
                return;
            }
            
            updateStatus(playerId, 'Requesting game state...');
            socket.emit('cliente_solicitar_estado_juego');
        }
        
        function updateStatus(playerId, message) {
            const statusElement = document.getElementById(`${playerId}Status`);
            const timestamp = new Date().toLocaleTimeString();
            statusElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            // Auto scroll to bottom
            statusElement.scrollTop = statusElement.scrollHeight;
        }
        
        function updatePlayerCards(playerId, gameState) {
            // Find the player in the game state
            const userId = playerId === 'player1' ? 5 : 6; // Based on our known user IDs
            const player = gameState.jugadores.find(p => p.id === userId);
            
            const cardsContainer = document.getElementById(`${playerId}Cards`);
            cardsContainer.innerHTML = '';
            
            // Show whose turn it is
            if (gameState.estadoRondaActual && gameState.estadoRondaActual.jugadorTurnoActualId === userId) {
                const turnIndicator = document.createElement('div');
                turnIndicator.style.backgroundColor = '#4caf50';
                turnIndicator.style.padding = '5px';
                turnIndicator.style.marginBottom = '10px';
                turnIndicator.style.borderRadius = '4px';
                turnIndicator.style.fontWeight = 'bold';
                turnIndicator.textContent = '¡ES TU TURNO!';
                cardsContainer.appendChild(turnIndicator);
            }
            
            if (player && player.cartasMano) {
                players[playerId].cards = player.cartasMano;
                
                player.cartasMano.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = `card ${card.palo}`;
                    cardElement.textContent = `${card.numero} ${card.palo}`;
                    cardElement.dataset.index = index;
                    
                    // Only allow playing cards if it's this player's turn
                    if (gameState.estadoRondaActual && gameState.estadoRondaActual.jugadorTurnoActualId === userId) {
                        cardElement.style.cursor = 'pointer';
                        cardElement.style.border = '2px solid gold';
                        cardElement.addEventListener('click', () => playCard(playerId, card));
                    }
                    
                    cardsContainer.appendChild(cardElement);
                });
                
                // Add actions buttons (Truco, Envido, etc.) if it's player's turn
                if (gameState.estadoRondaActual && gameState.estadoRondaActual.jugadorTurnoActualId === userId) {
                    const actionDiv = document.createElement('div');
                    actionDiv.style.marginTop = '20px';
                    actionDiv.style.display = 'flex';
                    actionDiv.style.gap = '10px';
                    
                    // Envido button if it's still allowed (first round, no envido yet)
                    if (gameState.estadoRondaActual.manoActualNumero === 1 && 
                        gameState.estadoRondaActual.envidoState && 
                        gameState.estadoRondaActual.envidoState.puedeCantarEnvidoGeneral) {
                        const envidoBtn = document.createElement('button');
                        envidoBtn.textContent = 'Envido';
                        envidoBtn.onclick = () => cantarEnvido(playerId);
                        actionDiv.appendChild(envidoBtn);
                    }
                    
                    // Truco button if no truco yet or can re-raise
                    const trucoBtn = document.createElement('button');
                    trucoBtn.textContent = 'Truco';
                    trucoBtn.onclick = () => cantarTruco(playerId);
                    actionDiv.appendChild(trucoBtn);
                    
                    // Irse al mazo button
                    const mazoBtn = document.createElement('button');
                    mazoBtn.textContent = 'Me voy al mazo';
                    mazoBtn.onclick = () => irseAlMazo(playerId);
                    actionDiv.appendChild(mazoBtn);
                    
                    cardsContainer.appendChild(actionDiv);
                }
            } else {
                cardsContainer.textContent = 'No cards available';
            }
            
            // Display cards on the table
            const tableCardsDiv = document.createElement('div');
            tableCardsDiv.style.marginTop = '20px';
            tableCardsDiv.style.padding = '10px';
            tableCardsDiv.style.backgroundColor = '#4c6853';
            tableCardsDiv.style.borderRadius = '8px';
            
            const tableTitle = document.createElement('h3');
            tableTitle.textContent = 'Cartas en la mesa:';
            tableTitle.style.margin = '0 0 10px 0';
            tableCardsDiv.appendChild(tableTitle);
            
            const tableFlex = document.createElement('div');
            tableFlex.style.display = 'flex';
            tableFlex.style.gap = '10px';
            tableCardsDiv.appendChild(tableFlex);
            
            if (gameState.estadoRondaActual && gameState.estadoRondaActual.cartasEnMesaManoActual.length > 0) {
                gameState.estadoRondaActual.cartasEnMesaManoActual.forEach(playedCard => {
                    const playerName = gameState.jugadores.find(j => j.id === playedCard.jugadorId)?.nombreUsuario;
                    const cardWrapper = document.createElement('div');
                    cardWrapper.style.textAlign = 'center';
                    
                    const cardElement = document.createElement('div');
                    cardElement.className = `card ${playedCard.carta.palo}`;
                    cardElement.textContent = `${playedCard.carta.numero} ${playedCard.carta.palo}`;
                    
                    const nameLabel = document.createElement('div');
                    nameLabel.textContent = playerName || 'Jugador';
                    nameLabel.style.marginTop = '5px';
                    
                    cardWrapper.appendChild(cardElement);
                    cardWrapper.appendChild(nameLabel);
                    tableFlex.appendChild(cardWrapper);
                });
            } else {
                const noCardsMessage = document.createElement('p');
                noCardsMessage.textContent = 'No hay cartas jugadas aún';
                noCardsMessage.style.margin = '10px 0';
                tableFlex.appendChild(noCardsMessage);
            }
            
            cardsContainer.appendChild(tableCardsDiv);
        }
        
        function playCard(playerId, card) {
            const socket = players[playerId].socket;
            
            if (!socket || !socket.connected) {
                updateStatus(playerId, 'Error: Not connected to server');
                return;
            }
            
            updateStatus(playerId, `Playing card: ${card.numero} of ${card.palo}`);
            socket.emit('cliente_jugar_carta', { carta: card });
        }
        
        function cantarEnvido(playerId) {
            const socket = players[playerId].socket;
            
            if (!socket || !socket.connected) {
                updateStatus(playerId, 'Error: Not connected to server');
                return;
            }
            
            updateStatus(playerId, `Cantando Envido`);
            socket.emit('cliente_cantar', { tipo_canto: 'ENVIDO', detalle_adicional: null });
        }
        
        function cantarTruco(playerId) {
            const socket = players[playerId].socket;
            
            if (!socket || !socket.connected) {
                updateStatus(playerId, 'Error: Not connected to server');
                return;
            }
            
            updateStatus(playerId, `Cantando Truco`);
            socket.emit('cliente_cantar', { tipo_canto: 'TRUCO', detalle_adicional: null });
        }
        
        function irseAlMazo(playerId) {
            const socket = players[playerId].socket;
            
            if (!socket || !socket.connected) {
                updateStatus(playerId, 'Error: Not connected to server');
                return;
            }
            
            updateStatus(playerId, `Yendo al mazo`);
            socket.emit('cliente_irse_al_mazo', {});
        }
    </script>
</body>
</html>