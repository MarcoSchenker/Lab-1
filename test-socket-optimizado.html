<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Socket Optimizado - Conexión Estable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.connecting { background-color: #fff3cd; color: #856404; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .logs {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .metric-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Test Socket Optimizado - Verificación de Conexión Estable</h1>
        
        <div id="status" class="status connecting">
            🔄 Conectando...
        </div>

        <div class="controls">
            <button id="connectBtn" class="btn-primary">Conectar a Sala de Prueba</button>
            <button id="disconnectBtn" class="btn-danger">Desconectar</button>
            <button id="clearLogsBtn" class="btn-warning">Limpiar Logs</button>
            <button id="testStabilityBtn" class="btn-success">Test de Estabilidad (5 min)</button>
        </div>

        <div class="metrics">
            <div class="metric">
                <div id="connectionCount" class="metric-value">0</div>
                <div class="metric-label">Conexiones</div>
            </div>
            <div class="metric">
                <div id="disconnectionCount" class="metric-value">0</div>
                <div class="metric-label">Desconexiones</div>
            </div>
            <div class="metric">
                <div id="reconnectionCount" class="metric-value">0</div>
                <div class="metric-label">Reconexiones</div>
            </div>
            <div class="metric">
                <div id="uptime" class="metric-value">0s</div>
                <div class="metric-label">Tiempo Activo</div>
            </div>
            <div class="metric">
                <div id="stabilityScore" class="metric-value">100%</div>
                <div class="metric-label">Estabilidad</div>
            </div>
        </div>

        <div class="logs" id="logs">
            📋 Logs de conexión aparecerán aquí...\n
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        class SocketStabilityTester {
            constructor() {
                this.socket = null;
                this.connectionCount = 0;
                this.disconnectionCount = 0;
                this.reconnectionCount = 0;
                this.startTime = null;
                this.isStabilityTest = false;
                this.stabilityTestDuration = 5 * 60 * 1000; // 5 minutos
                this.uptimeInterval = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.startUptimeCounter();
                
                // Auto-conectar para test
                setTimeout(() => this.connect(), 1000);
            }

            initializeElements() {
                this.statusEl = document.getElementById('status');
                this.logsEl = document.getElementById('logs');
                this.connectionCountEl = document.getElementById('connectionCount');
                this.disconnectionCountEl = document.getElementById('disconnectionCount');
                this.reconnectionCountEl = document.getElementById('reconnectionCount');
                this.uptimeEl = document.getElementById('uptime');
                this.stabilityScoreEl = document.getElementById('stabilityScore');
            }

            setupEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('clearLogsBtn').addEventListener('click', () => this.clearLogs());
                document.getElementById('testStabilityBtn').addEventListener('click', () => this.startStabilityTest());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
                const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
                
                this.logsEl.textContent += logMessage;
                this.logsEl.scrollTop = this.logsEl.scrollHeight;
                
                console.log(`[SocketTest] ${message}`);
            }

            updateStatus(message, type) {
                this.statusEl.textContent = message;
                this.statusEl.className = `status ${type}`;
            }

            updateMetrics() {
                this.connectionCountEl.textContent = this.connectionCount;
                this.disconnectionCountEl.textContent = this.disconnectionCount;
                this.reconnectionCountEl.textContent = this.reconnectionCount;
                
                // Calcular score de estabilidad
                const totalEvents = this.connectionCount + this.disconnectionCount + this.reconnectionCount;
                const stabilityScore = totalEvents > 0 
                    ? Math.max(0, 100 - ((this.disconnectionCount + this.reconnectionCount) / totalEvents * 100))
                    : 100;
                
                this.stabilityScoreEl.textContent = `${stabilityScore.toFixed(1)}%`;
                this.stabilityScoreEl.parentElement.style.backgroundColor = 
                    stabilityScore >= 90 ? '#d4edda' : 
                    stabilityScore >= 70 ? '#fff3cd' : '#f8d7da';
            }

            startUptimeCounter() {
                this.startTime = Date.now();
                this.uptimeInterval = setInterval(() => {
                    if (this.socket && this.socket.connected) {
                        const uptime = Math.floor((Date.now() - this.startTime) / 1000);
                        this.uptimeEl.textContent = `${uptime}s`;
                    }
                }, 1000);
            }

            connect() {
                if (this.socket && this.socket.connected) {
                    this.log('Socket ya está conectado', 'warning');
                    return;
                }

                this.log('🔄 Iniciando conexión optimizada...');
                this.updateStatus('🔄 Conectando...', 'connecting');

                // Simular autenticación
                const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNzUwMDAyOTcwLCJleHAiOjE3NTA2MDc3NzB9.ymALG6P7Aw4KOuDsF3Bp1rLQZCGESVJVYfxrb20T484';
                const testRoomCode = 'test-optimizado-' + Math.random().toString(36).substr(2, 8);

                this.socket = io('http://localhost:3001', {
                    query: { 
                        codigoSala: testRoomCode,
                        token: mockToken,
                        anonymous: false 
                    },
                    transports: ['websocket', 'polling'],
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    randomizationFactor: 0.5,
                    autoConnect: true
                });

                this.setupSocketEvents();
            }

            setupSocketEvents() {
                this.socket.on('connect', () => {
                    this.connectionCount++;
                    this.log(`✅ Socket conectado: ${this.socket.id}`, 'success');
                    this.updateStatus('✅ Conectado', 'connected');
                    this.updateMetrics();
                    
                    // Autenticar
                    const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNzUwMDAyOTcwLCJleHAiOjE3NTA2MDc3NzB9.ymALG6P7Aw4KOuDsF3Bp1rLQZCGESVJVYfxrb20T484';
                    this.socket.emit('autenticar_socket', mockToken);
                });

                this.socket.on('disconnect', (reason) => {
                    this.disconnectionCount++;
                    this.log(`🔌 Socket desconectado: ${reason}`, 'warning');
                    this.updateStatus('🔌 Desconectado', 'error');
                    this.updateMetrics();
                });

                this.socket.on('reconnect', (attemptNumber) => {
                    this.reconnectionCount++;
                    this.log(`🔄 Reconectado después de ${attemptNumber} intentos`, 'success');
                    this.updateMetrics();
                });

                this.socket.on('reconnect_attempt', (attemptNumber) => {
                    this.log(`🔄 Intento de reconexión #${attemptNumber}`);
                    this.updateStatus(`🔄 Reconectando... (${attemptNumber})`, 'connecting');
                });

                this.socket.on('reconnect_error', (error) => {
                    this.log(`❌ Error de reconexión: ${error.message}`, 'error');
                });

                this.socket.on('connect_error', (error) => {
                    this.log(`❌ Error de conexión: ${error.message}`, 'error');
                    this.updateStatus('❌ Error de conexión', 'error');
                });

                this.socket.on('autenticacion_exitosa', (data) => {
                    this.log(`✅ Autenticación exitosa: ${JSON.stringify(data)}`, 'success');
                });

                this.socket.on('autenticacion_fallida', (error) => {
                    this.log(`❌ Error de autenticación: ${error}`, 'error');
                });

                // Eventos específicos del juego
                this.socket.on('unido_sala_juego', (data) => {
                    this.log(`✅ Unido a sala: ${JSON.stringify(data)}`, 'success');
                });

                this.socket.on('error_unirse_sala', (error) => {
                    this.log(`❌ Error uniéndose a sala: ${error}`, 'error');
                });

                this.socket.on('estado_juego_actualizado', (estado) => {
                    this.log(`🎯 Estado actualizado (equipos: ${estado.equipos?.length || 0})`, 'success');
                });
            }

            disconnect() {
                if (this.socket) {
                    this.log('🔌 Desconectando manualmente...');
                    this.socket.disconnect();
                    this.socket = null;
                    this.updateStatus('🔌 Desconectado', 'error');
                    
                    if (this.isStabilityTest) {
                        this.stopStabilityTest();
                    }
                }
            }

            clearLogs() {
                this.logsEl.textContent = '📋 Logs limpiados...\n';
            }

            startStabilityTest() {
                if (this.isStabilityTest) {
                    this.log('Test de estabilidad ya está en progreso', 'warning');
                    return;
                }

                this.isStabilityTest = true;
                this.log(`🚀 Iniciando test de estabilidad de ${this.stabilityTestDuration / 1000 / 60} minutos...`, 'success');
                
                // Resetear métricas para el test
                this.connectionCount = 0;
                this.disconnectionCount = 0;
                this.reconnectionCount = 0;
                this.startTime = Date.now();
                this.updateMetrics();

                // Conectar si no está conectado
                if (!this.socket || !this.socket.connected) {
                    this.connect();
                }

                // Programar fin del test
                setTimeout(() => {
                    this.stopStabilityTest();
                }, this.stabilityTestDuration);

                // Actualizar botón
                const btn = document.getElementById('testStabilityBtn');
                btn.textContent = 'Test en progreso...';
                btn.disabled = true;
            }

            stopStabilityTest() {
                if (!this.isStabilityTest) return;

                this.isStabilityTest = false;
                
                const duration = (Date.now() - this.startTime) / 1000;
                const totalEvents = this.connectionCount + this.disconnectionCount + this.reconnectionCount;
                const stabilityScore = totalEvents > 0 
                    ? Math.max(0, 100 - ((this.disconnectionCount + this.reconnectionCount) / totalEvents * 100))
                    : 100;

                this.log(`🏁 Test de estabilidad completado:`, 'success');
                this.log(`   ⏱️ Duración: ${duration.toFixed(1)}s`);
                this.log(`   🔌 Conexiones: ${this.connectionCount}`);
                this.log(`   ❌ Desconexiones: ${this.disconnectionCount}`);
                this.log(`   🔄 Reconexiones: ${this.reconnectionCount}`);
                this.log(`   📊 Score de estabilidad: ${stabilityScore.toFixed(1)}%`);

                // Determinar resultado
                if (stabilityScore >= 95) {
                    this.log(`🎉 EXCELENTE: Socket muy estable`, 'success');
                } else if (stabilityScore >= 85) {
                    this.log(`✅ BUENO: Socket estable con ocasionales reconexiones`, 'success');
                } else if (stabilityScore >= 70) {
                    this.log(`⚠️ ACEPTABLE: Socket con algunas desconexiones`, 'warning');
                } else {
                    this.log(`❌ PROBLEMÁTICO: Socket inestable, necesita optimización`, 'error');
                }

                // Restaurar botón
                const btn = document.getElementById('testStabilityBtn');
                btn.textContent = 'Test de Estabilidad (5 min)';
                btn.disabled = false;
            }
        }

        // Inicializar tester cuando la página carga
        document.addEventListener('DOMContentLoaded', () => {
            new SocketStabilityTester();
        });
    </script>
</body>
</html>
