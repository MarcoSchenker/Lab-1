<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - useGameSocket</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .log { margin: 5px 0; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #b6d4fe; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 12px 24px; margin: 8px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .status { display: flex; gap: 20px; margin: 20px 0; }
        .status-item { padding: 10px; border-radius: 4px; flex: 1; text-align: center; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
        .logs-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Final - useGameSocket Hook</h1>
        
        <div class="status">
            <div id="connection-status" class="status-item disconnected">
                üî¥ Desconectado
            </div>
            <div id="room-status" class="status-item loading">
                üîÑ Sin sala
            </div>
            <div id="game-status" class="status-item loading">
                ‚è≥ Sin estado
            </div>
        </div>
        
        <div>
            <button class="btn-primary" onclick="testConnection()">üîå Test Conexi√≥n</button>
            <button class="btn-success" onclick="joinTestRoom()">üéÆ Unirse a Sala Test</button>
            <button class="btn-danger" onclick="disconnect()">‚ùå Desconectar</button>
            <button class="btn-secondary" onclick="clearLogs()">üßπ Limpiar Logs</button>
        </div>
        
        <h3>üìã Logs de Conexi√≥n</h3>
        <div id="logs" class="logs-container"></div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const SERVER_URL = 'http://localhost:3001';
        let socket = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let currentRoom = null;
        
        // Simular refs de React
        let isConnectingRef = false;
        let isCleaningUpRef = false;
        let currentRoomRef = null;
        let hasConnectedOnceRef = false;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('logs').appendChild(div);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function updateStatus(connection, room, game) {
            const connStatus = document.getElementById('connection-status');
            const roomStatus = document.getElementById('room-status');
            const gameStatus = document.getElementById('game-status');
            
            if (connection === 'connected') {
                connStatus.textContent = 'üü¢ Conectado';
                connStatus.className = 'status-item connected';
            } else if (connection === 'connecting') {
                connStatus.textContent = 'üîÑ Conectando...';
                connStatus.className = 'status-item loading';
            } else {
                connStatus.textContent = 'üî¥ Desconectado';
                connStatus.className = 'status-item disconnected';
            }
            
            if (room) {
                roomStatus.textContent = `üéÆ Sala: ${room}`;
                roomStatus.className = 'status-item connected';
            } else {
                roomStatus.textContent = 'üîÑ Sin sala';
                roomStatus.className = 'status-item loading';
            }
            
            if (game) {
                gameStatus.textContent = '‚úÖ Estado recibido';
                gameStatus.className = 'status-item connected';
            } else {
                gameStatus.textContent = '‚è≥ Sin estado';
                gameStatus.className = 'status-item loading';
            }
        }
        
        function connectSocket(codigoSala) {
            log(`üîç Debug connectSocket llamado con codigoSala: ${codigoSala}`, 'info');
            
            if (!codigoSala) {
                log('‚ùå C√≥digo de sala no proporcionado o es undefined/null', 'error');
                return;
            }
            
            // Evitar m√∫ltiples conexiones simult√°neas
            if (isConnectingRef) {
                log('üîÑ Conexi√≥n ya en progreso, ignorando nueva solicitud', 'warning');
                return;
            }
            
            // Evitar reconexi√≥n durante cleanup
            if (isCleaningUpRef) {
                log('üßπ Cleanup en progreso, ignorando conexi√≥n', 'warning');
                return;
            }

            if (socket && socket.connected) {
                log('‚úÖ Socket ya conectado, verificando sala actual', 'info');
                // Si estamos conectados a la misma sala, no reconectar
                if (currentRoomRef === codigoSala) {
                    log('‚úÖ Ya conectado a la sala correcta', 'success');
                    return;
                }
            }

            isConnectingRef = true;
            log(`üîå Conectando a sala ${codigoSala}...`, 'info');
            updateStatus('connecting', codigoSala, false);

            const token = 'test-token-' + Date.now();
            const anonymous = false;

            // Desconectar socket existente si est√° conectado a otra sala
            if (socket && currentRoomRef !== codigoSala) {
                log(`üîÑ Desconectando de sala anterior: ${currentRoomRef}`, 'info');
                socket.disconnect();
                socket = null;
            }

            const newSocket = io(SERVER_URL, {
                query: { codigoSala, token, anonymous },
                transports: ['websocket', 'polling'],
                autoConnect: false,
                forceNew: true,
            });

            socket = newSocket;
            currentRoomRef = codigoSala;
            newSocket.connect();

            // === EVENTOS DE CONEXI√ìN ===
            newSocket.on('connect', () => {
                log(`‚úÖ Socket conectado: ${newSocket.id}`, 'success');
                
                // Marcar timestamp de conexi√≥n para detectar cleanup inmediato
                newSocket.connectedAt = Date.now();
                hasConnectedOnceRef = true;
                
                isConnectingRef = false;
                reconnectAttempts = 0;
                updateStatus('connected', codigoSala, false);
                
                // Autenticar con token
                if (token) {
                    newSocket.emit('autenticar_socket', token);
                }
            });

            newSocket.on('disconnect', (reason) => {
                log(`‚ùå Socket desconectado: ${reason}`, 'error');
                updateStatus('disconnected', currentRoomRef, false);
                isConnectingRef = false;
            });

            // === EVENTOS DE AUTENTICACI√ìN ===
            newSocket.on('autenticacion_exitosa', (data) => {
                log(`‚úÖ Socket autenticado: ${JSON.stringify(data)}`, 'success');
                
                if (codigoSala) {
                    log(`üì° Emitiendo unirse_sala_juego con c√≥digo: ${codigoSala}`, 'info');
                    newSocket.emit('unirse_sala_juego', codigoSala);
                }
            });

            newSocket.on('autenticacion_fallida', (error) => {
                log(`‚ùå Error de autenticaci√≥n: ${error}`, 'error');
                isConnectingRef = false;
                updateStatus('disconnected', codigoSala, false);
            });

            // === EVENTOS DE SALA ===
            newSocket.on('union_sala_exitosa', (data) => {
                log(`‚úÖ Unido a sala exitosamente: ${JSON.stringify(data)}`, 'success');
                updateStatus('connected', codigoSala, false);
            });

            // === EVENTOS DE JUEGO ===
            newSocket.on('partida_iniciada', (estadoInicial) => {
                log(`üöÄ Partida iniciada: ${JSON.stringify(estadoInicial)}`, 'success');
                updateStatus('connected', codigoSala, true);
            });

            newSocket.on('estado_juego_actualizado', (estado) => {
                log(`üéØ Estado actualizado: ${JSON.stringify(estado)}`, 'success');
                updateStatus('connected', codigoSala, true);
            });

            // === EVENTOS DE ERROR ===
            newSocket.on('error_union_sala', (error) => {
                log(`‚ùå Error uni√©ndose a sala: ${error}`, 'error');
                isConnectingRef = false;
                updateStatus('disconnected', codigoSala, false);
            });
        }
        
        function simulateReactDevModeCleanup() {
            log('üßπ Simulando cleanup de React Dev Mode...', 'warning');
            
            if (!socket) {
                log('‚ö†Ô∏è No hay socket para hacer cleanup', 'warning');
                return;
            }
            
            // Simular la l√≥gica de cleanup del hook
            const isReactDevMode = true; // Simulamos que estamos en dev mode
            const connectionAge = socket.connectedAt ? Date.now() - socket.connectedAt : 0;
            const isImmediateCleanup = connectionAge < 500;
            
            log(`üîç Cleanup check: devMode=${isReactDevMode}, age=${connectionAge}ms, immediate=${isImmediateCleanup}, connected=${socket.connected}, hasConnected=${hasConnectedOnceRef}`, 'info');
            
            // Evitar cleanup inmediato en React Dev Mode cuando es la primera conexi√≥n
            if (isReactDevMode && isImmediateCleanup && socket.connected && hasConnectedOnceRef) {
                log('üîÑ React Dev Mode detectado, evitando cleanup inmediato (primera conexi√≥n)', 'success');
                return;
            }
            
            // Tambi√©n evitar cleanup si acabamos de conectar
            if (hasConnectedOnceRef && connectionAge < 1000) {
                log('üîÑ Conexi√≥n muy reciente, evitando cleanup prematuro', 'success');  
                return;
            }
            
            // Si llegamos aqu√≠, hacer cleanup normal
            log('üîÑ Ejecutando cleanup completo', 'warning');
            isCleaningUpRef = true;
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            isConnectingRef = false;
            currentRoomRef = null;
            hasConnectedOnceRef = false;
            updateStatus('disconnected', null, false);
            
            // Reset cleanup flag despu√©s de un delay
            setTimeout(() => {
                isCleaningUpRef = false;
            }, 100);
        }
        
        function testConnection() {
            const testRoom = 'test-room-' + Date.now();
            log(`üß™ Iniciando test de conexi√≥n con sala: ${testRoom}`, 'info');
            connectSocket(testRoom);
            
            // Simular React Dev Mode cleanup despu√©s de poco tiempo
            setTimeout(() => {
                log('‚ö° Simulando efecto de React Dev Mode (cleanup inmediato)...', 'warning');
                simulateReactDevModeCleanup();
            }, 200);
            
            // Simualr segundo mount de React Dev Mode
            setTimeout(() => {
                log('‚ö° Simulando segundo mount de React Dev Mode...', 'info');
                connectSocket(testRoom);
            }, 300);
        }
        
        function joinTestRoom() {
            const testRoom = 'test-multiplayer-' + Date.now();
            log(`üéÆ Uni√©ndose a sala de prueba: ${testRoom}`, 'info');
            connectSocket(testRoom);
        }
        
        function disconnect() {
            if (socket) {
                log('‚ùå Desconectando socket manualmente...', 'warning');
                socket.disconnect();
                socket = null;
                updateStatus('disconnected', null, false);
                
                // Reset flags
                isConnectingRef = false;
                isCleaningUpRef = false;
                currentRoomRef = null;
                hasConnectedOnceRef = false;
            } else {
                log('‚ö†Ô∏è No hay socket conectado para desconectar', 'warning');
            }
        }
        
        // Inicializar
        log('üîß Test del hook useGameSocket listo. Usa los botones para probar.', 'info');
        updateStatus('disconnected', null, false);
    </script>
</body>
</html>
